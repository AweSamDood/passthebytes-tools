name: Manual Deploy to Production

on:
  workflow_dispatch:  # Manual deployment only
    inputs:
      version_selection:
        description: 'Version selection method'
        required: true
        type: choice
        options:
          - latest
          - previous
          - specific
        default: 'latest'
      specific_version:
        description: 'Specific version (only used if "specific" is selected above, e.g., 1.2.2 WITHOUT the v prefix)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: self-hosted
    environment: production

    steps:
      - name: Determine version to deploy
        id: version
        run: |
          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          
          case "${{ github.event.inputs.version_selection }}" in
            latest)
              # Get the latest release tag
              LATEST_TAG=$(git ls-remote --tags --refs --sort="v:refname" "$REPO_URL" | tail -n1 | sed 's/.*\///')
              if [ -z "$LATEST_TAG" ]; then
                echo "Error: No tags found in the repository. Please create a release first."
                exit 1
              fi
              VERSION=${LATEST_TAG#v}
              echo "Using latest release: $VERSION (tag: $LATEST_TAG)"
              ;;
            previous)
              # Get the second latest release tag
              TAG_COUNT=$(git ls-remote --tags --refs "$REPO_URL" | wc -l)
              if [ "$TAG_COUNT" -lt 2 ]; then
                echo "Error: Less than 2 tags found in the repository. Cannot select 'previous' version."
                echo "Available tags: $TAG_COUNT"
                exit 1
              fi
              PREV_TAG=$(git ls-remote --tags --refs --sort="v:refname" "$REPO_URL" | tail -n2 | head -n1 | sed 's/.*\///')
              VERSION=${PREV_TAG#v}
              echo "Using previous release: $VERSION (tag: $PREV_TAG)"
              ;;
            specific)
              VERSION="${{ github.event.inputs.specific_version }}"
              if [ -z "$VERSION" ]; then
                echo "Error: Specific version selected but no version provided."
                echo "Please enter a version number (e.g., 1.2.2) in the 'Specific version' field."
                exit 1
              fi
              # Remove 'v' prefix if user accidentally included it
              VERSION=${VERSION#v}
              echo "Using specific version: $VERSION"
              ;;
          esac
          
          # Final validation
          if [ -z "$VERSION" ]; then
            echo "Error: Failed to determine version. VERSION is empty."
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Will deploy version: $VERSION"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.tag }}

      - name: Verify project directory exists
        run: |
          PROJECT_PATH="${{ secrets.PROJECT_PATH || '/opt/passthebytes-tools' }}"
          if [ ! -d "$PROJECT_PATH" ]; then
            echo "âŒ Project directory does not exist: $PROJECT_PATH"
            exit 1
          fi
          echo "âœ… Project directory verified: $PROJECT_PATH"

      - name: Create backup and sync code
        run: |
          PROJECT_PATH="${{ secrets.PROJECT_PATH || '/opt/passthebytes-tools' }}"
          cd "$PROJECT_PATH"

          # Verify we're in the right directory
          if [ ! -f "deployment/deploy.sh" ]; then
            echo "âŒ Error: Not in the correct project directory"
            echo "Expected to find deployment/deploy.sh in: $(pwd)"
            ls -la
            exit 1
          fi

          echo "ðŸ“ Current working directory: $(pwd)"
          echo "ðŸ“¦ Syncing code from GitHub Actions workspace..."

          # Create a backup of current state before syncing
          if [ -d ".git" ]; then
            echo "ðŸ“‹ Current commit: $(git rev-parse HEAD)"
          fi

          # Sync the checked-out code (preserve .git and other important files)
          rsync -av \
            --exclude='.git/' \
            --exclude='node_modules/' \
            --exclude='backend/uploads/' \
            --exclude='deployments/' \
            "$GITHUB_WORKSPACE/" ./

          echo "âœ… Code synced successfully"

      - name: Run deployment script
        run: |
          PROJECT_PATH="${{ secrets.PROJECT_PATH || '/opt/passthebytes-tools' }}"
          cd "$PROJECT_PATH"

          echo "ðŸš€ Starting deployment..."

          # Use the version determined in the first step
          export VERSION="${{ steps.version.outputs.version }}"
          echo -n "$VERSION" > VERSION
          echo "ðŸ“¦ Deploying version: $VERSION"

          # Make sure deploy script is executable
          chmod +x deployment/deploy.sh

          # Run deployment script
          ./deployment/deploy.sh production

      - name: Verify deployment health
        run: |
          echo "â³ Waiting for services to stabilize..."
          sleep 15

          echo "ðŸ” Running health checks..."

          # Check backend health
          if curl -f http://localhost:3031/health > /dev/null 2>&1; then
            echo "âœ… Backend health check passed"
          else
            echo "âŒ Backend health check failed"
            exit 1
          fi

          # Check frontend accessibility
          if curl -f http://localhost:3031 > /dev/null 2>&1; then
            echo "âœ… Frontend accessibility check passed"
          else
            echo "âŒ Frontend accessibility check failed"
            exit 1
          fi

          echo "ðŸŽ‰ Deployment completed successfully!"

      - name: Log deployment info
        if: always()
        run: |
          PROJECT_PATH="${{ secrets.PROJECT_PATH || '/opt/passthebytes-tools' }}"
          cd "$PROJECT_PATH"

          # Create deployments directory if it doesn't exist
          mkdir -p deployments

          # Log deployment status
          if [ "${{ job.status }}" = "success" ]; then
            echo "$(date +'%Y-%m-%d %H:%M:%S') - âœ… Deployment successful (commit: ${{ github.sha }})" >> deployments/deployment.log
          else
            echo "$(date +'%Y-%m-%d %H:%M:%S') - âŒ Deployment failed (commit: ${{ github.sha }})" >> deployments/deployment.log
          fi

  # Post-deployment tests
  post-deploy-tests:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make test script executable
        run: chmod +x ./deployment/post-deploy-tests.sh

      - name: Run post-deployment tests on live site
        run: ./deployment/post-deploy-tests.sh https://tools.passthebytes.com
